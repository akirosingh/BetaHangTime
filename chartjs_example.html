<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>How to add Chartjs Plugin Streaming in Chart.js</title>
    <style type="text/css"></style>
  </head>
  <body>
    <button id="toggleButton" onclick="toggleStreaming()">
      Start Streaming
    </button>
    <button id="resetButton" onclick="resetData()">Reset</button>
    <button id="exportButton" onclick="exportData()">Export Data</button>

    <div>
      <canvas id="myChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@1.27.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>
    <script>
      let isStreaming = false; // Variable to keep track of streaming state

      function toggleStreaming() {
        isStreaming = !isStreaming; // Toggle the streaming state
        myChart.options.scales.x.realtime.pause = !isStreaming; // Update the chart pause option
        myChart.update(); // Update the chart to reflect the change

        // Update the button text based on the new streaming state
        const button = document.getElementById("toggleButton");
        button.textContent = isStreaming ? "Stop Streaming" : "Start Streaming";
      }
      function resetData() {
        // Set the data arrays of both datasets to empty arrays
        myChart.data.datasets[0].data = [];
        myChart.data.datasets[1].data = [];

        // Update the chart to reflect the change
        myChart.update();
      }

      // setup block
      const data = {
        datasets: [
          {
            label: "Right Hand",
            data: [],
            backgroundColor: "rgba(255, 99, 132, 0.2)",
            borderColor: "rgb(255, 99, 132)",
            borderWidth: 1,
            fill: "origin",
          },
          {
            label: "Left Hand",
            data: [],
            backgroundColor: "rgba(255, 159, 64, 0.2)",
            borderColor: "rgb(255, 159, 64)",
            borderWidth: 1,
            fill: "origin",
          },
        ],
      };
      // config black
      const config = {
        type: "line",
        data,
        options: {
          plugins: {
            streaming: {
              ttl: 3600000,
            },
          },
          interaction: {
            intersect: false,
          },
          scales: {
            x: {
              type: "realtime",
              realtime: {
                onRefresh: (chart) => {
                  chart.data.datasets.forEach((dataset) => {
                    var lastDataPoint = dataset.data[dataset.data.length - 1];
                    var lastYValue = lastDataPoint ? lastDataPoint.y : 0; // If there's no last data point, assume a previous y value of 0
                    var newYValue = Math.round(Math.random()); // Add a random value to the previous y value
                    // Now create a new data point with the current datetime for x and the updated y value
                    var newDataPoint = {
                      x: Date.now(),
                      y: newYValue,
                    };

                    // Push the new data point to your dataset
                    dataset.data.push(newDataPoint);
                  });
                },
              },
            },
            y: {
              beginAtZero: true,
            },
          },
        },
      };
      function exportData() {
    // Get the datasets from the chart
    const leftHandData = myChart.data.datasets[0].data;
    const rightHandData = myChart.data.datasets[1].data;

    // Create CSV content
    let csvContent = "data:text/csv;charset=utf-8,Time,Left Hand,Right Hand\n";

    // Assume both datasets have the same length and x values
    for (let i = 0; i < leftHandData.length; i++) {
        // Convert the timestamp to a human-readable time format in the user's local time zone
        const timestamp = new Date(leftHandData[i].x);
        const formattedTime = timestamp.toLocaleString("en-US", { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        const row = [
            formattedTime,
            leftHandData[i].y,
            rightHandData[i].y
        ].join(',');

        csvContent += row + '\n';
    }

    // Encode CSV content
    const encodedUri = encodeURI(csvContent);

    // Create download link and click it to initiate download
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "export.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};



      // render init block
      const myChart = new Chart(document.getElementById("myChart"), config);
    </script>
  </body>
</html>
